/**
	 * 导出Excel表格
	 * @return
	 * @throws Exception
	 */
	public String outExcel() throws Exception {		
		String excelName = "充值记录报表"
		+ System.currentTimeMillis() + ".xls";
		OutputStream os = null;
		HttpServletResponse response = ServletActionContext.getResponse();
		HttpServletRequest request = ServletActionContext.getRequest();
		response.setCharacterEncoding("UTF-8");
		request.setCharacterEncoding("UTF-8");
		response.reset();// 清空输出流
		response.setHeader("Content-disposition", "attachment; filename="
				+ new String((excelName).getBytes("gbk"),"iso8859-1"));// 设定输出文件头
		response.setContentType("application/msexcel");// 定义输出类型
		os = response.getOutputStream();
        // 2.生成工作簿  
        WritableWorkbook wb = Workbook.createWorkbook(os);  
        // 3根据工作薄创建工作表  
        WritableSheet sheet = wb.createSheet("充值记录报表", 0);  
        
        String daiLiShang= request.getParameter("agentName");
        String diqu= request.getParameter("areaName");
        String duan= request.getParameter("teamName");
        String fu= request.getParameter("picName");
        String shangWu= request.getParameter("businessName");
        String keFU= request.getParameter("customerName");
        String xiangMu= request.getParameter("projectName");
        String chanPing= request.getParameter("ProductName");
        
		if("1".equals(daiLiShang)){
			daiLiShang="AGENT_NAMW";
		}
		
		if("2".equals(diqu)){
			diqu="AREA_NAME";
		}
		
		if("3".equals(duan)){
			duan="TEAM_NAME";
		}
		
		if("4".equals(fu)){
			fu="PIC_NAME";
		}
		
		
		if("5".equals(shangWu)){
			shangWu="BUSINESS_NAME";
		}
		
		if("6".equals(keFU)){
			keFU="CUSTOMER_NAME";
		}
		
		
		if("7".equals(xiangMu)){
			xiangMu="PROJECT_NAME";
		}
		
		if("8".equals(chanPing)){
			chanPing="PRODUCT_NAME";
		}
        
        int sum=0;
        // 4.生成单元格  
        Label label = new Label(sum++, 0, "充值时间");  
        sheet.addCell(label);

        if(daiLiShang!=null&&!daiLiShang.equals("")){
        	  label = new Label(sum++, 0, "代理商");  
              sheet.addCell(label);
        }
        
        if(duan!=null&&!duan.equals("")){
        label = new Label(sum++, 0, "团队");  
        sheet.addCell(label); 
        }
        
        if(diqu!=null&&!diqu.equals("")){
        label = new Label(sum++, 0, "地区");  
        sheet.addCell(label);
        }
        
        if(fu!=null&&!fu.equals("")){
        label = new Label(sum++, 0, "负责人");  
        sheet.addCell(label);
        }
        
        if(shangWu!=null&&!shangWu.equals("")){
        label = new Label(sum++, 0, "商务");  
        sheet.addCell(label); 
        }
        
        if(keFU!=null&&!keFU.equals("")){
        label = new Label(sum++, 0, "客户");  
        sheet.addCell(label); 
        }
        
        if(xiangMu!=null&&!xiangMu.equals("")){
        label = new Label(sum++, 0, "项目");  
        sheet.addCell(label);
        }
        
        if(chanPing!=null&&!chanPing.equals("")){
        label = new Label(sum++, 0, "产品");  
        sheet.addCell(label); 
        }
        
        label = new Label(sum++, 0, "充值次数");  
        sheet.addCell(label);
        
        label = new Label(sum++, 0, "充值人数");  
        sheet.addCell(label);
        
        label = new Label(sum++, 0, "老客户成交金额");  
        sheet.addCell(label);
        
        label = new Label(sum++, 0, "新客户成交金额");  
        sheet.addCell(label);
        
        sheet.addCell(label);
		String daiLiShangs= request.getParameter("daiLiShang");
		String diqus =request.getParameter("diqu");
		String duans =request.getParameter("duan");
		String fus =request.getParameter("fu");
		String shangWus =request.getParameter("shangWu");
		String keFus =request.getParameter("keFu");
		String xiangMus =request.getParameter("xiangMu");
		String chanPings =request.getParameter("chanPing");
		String yinHang =request.getParameter("yinHang");
		String shengzhou =request.getParameter("shengzhou");
		String zhiFuBao =request.getParameter("zhiFuBao");
		String lianTong =request.getParameter("lianTong");
		String dianXin =request.getParameter("dianXin");
		String youXi =request.getParameter("youXi");
		String kaishiriqi= request.getParameter("kaishiriqi");
		
		String agent1="";
		String agent2="";
		String area1="";
		String area2="";
		String team1="";
		String team2="";
		String pic1="";
		String pic2="";
		String business1="";
		String business2="";
		String customer1="";
		String customer2="";
		String project1="";
		String project2="";
		String product1="";
		String product2="";

		if(daiLiShang=="AGENT_NAMW"){
			agent1 =",i.agent_name as agentName";
			agent2 = ",i.agent_name";
		}
		
		if(diqu=="AREA_NAME"){
			area1=",h.area_name as areaName";
			area2=",h.area_name";
		}
		
		if(duan =="TEAM_NAME"){
			team1=",g.team_name as teamName";
			team2=",g.team_name";
		}
		
		if(fu =="PIC_NAME"){
			pic1=",f.pic_name as picName";
			pic2=",f.pic_name";
		}
		
		if(shangWu=="BUSINESS_NAME"){
			business1=",e.business_name as businessName";
			business2=",e.business_name";
		}
		
		if(keFU=="CUSTOMER_NAME"){
			customer1=",d.customer_name as customerName";
			customer2=",d.customer_name";
		}
		
		if(xiangMu=="PROJECT_NAME"){
			project1=",c.project_name as projectName";
			project2=",c.project_name";
		}
		
		if(chanPing=="PRODUCT_NAME"){
			product1=",b.product_name as productName";
			product2=",b.product_name";
		}

		String sql = "select SUM(CH_USER) AS SUM , SUM(OLD_CH) AS SUM1 ," +
		"SUM(NEW_CH) AS SUM2, SUM(CH_TIME) AS SUM3, SUM(PAY_TYPE) AS SUM4,stat_time"+agent1+area1+team1+pic1+business1+customer1+project1+product1+" from charge_stat a inner join product b on" +
		" a.product_id=b.product_id  inner join project c on" +
		" a.project_id=c.project_id  inner join customer d on" +
		" c.customer_id=d.customer_id inner join business e on" +
		" d.business_id=e.business_id inner join pic f on" +
		" e.pic_id=f.pic_id inner join team g on" +
		" f.team_id =g.team_id inner join area h on" +
		" g.area_id=h.area_id  inner join agent i on" +
		" h.agent_id=i.agent_id where  1=1 ";
		String sql_1=" group by  stat_time "+agent2+area2+team2+pic2+business2+customer2+project2+product2+"";
		String sql_="";
		String sql_0=" order by stat_time ASC";
		if(kaishiriqi!=null&&!kaishiriqi.equals("")){
			sql_+="and  STAT_TIME ='"+kaishiriqi+"'";
		}
		if(daiLiShangs!=null&&!daiLiShangs.equals("")){
			int ar=Integer.valueOf(request.getParameter("daiLiShang"));
			sql_+="and i.agent_id ="+ar;
		}
		if(diqus!=null&&!diqus.equals("")){
			int ar=Integer.valueOf(request.getParameter("diqu"));
			sql_+="and h.area_id="+ar;
		}
		if(duans!=null&&!duans.equals("")){
			int ar=Integer.valueOf(request.getParameter("duan"));
			sql_+="and g.team_id="+ar;
		}
		if(fus!=null&&!fus.equals("")){
			int ar=Integer.valueOf(request.getParameter("fu"));
			sql_+="and f.pic_id ="+ar;
		}
		if(shangWus!=null&&!shangWus.equals("")){
			int ar=Integer.valueOf(request.getParameter("shangWu"));
			sql_+="and e.business_id ="+ar;
		}
		if(keFus!=null&&!keFus.equals("")){
			int ar=Integer.valueOf(request.getParameter("keFu"));
			sql_+="and d.customer_id ="+ar;
		}
		if(xiangMus!=null&&!xiangMus.equals("")){
			int ar=Integer.valueOf(request.getParameter("xiangMu"));
			sql_+="and e.business_id ="+ar;
		}
		if(chanPings!=null&&!chanPings.equals("")){
			int ar=Integer.valueOf(request.getParameter("chanPing"));
			sql_+="and c.project_id ="+ar;
		}
		if(yinHang!=null&&!yinHang.equals("")){
			int ar=Integer.valueOf(request.getParameter("yinHang")=="on"?"-1":"0");
			sql_+="and PAY_TYPE ="+ar;
		}
		if(shengzhou!=null&&!shengzhou.equals("")){
			int ar=Integer.valueOf(request.getParameter("shengzhou")=="on"?"-1":"3");
			sql_+="and PAY_TYPE ="+ar;
		}
		if(zhiFuBao!=null&&!zhiFuBao.equals("")){
			int ar=Integer.valueOf(request.getParameter("zhiFuBao")=="on"?"-1":"1");
			sql_+="and PAY_TYPE ="+ar;
		}
		if(lianTong!=null&&!lianTong.equals("")){
			int ar=Integer.valueOf(request.getParameter("lianTong")=="on"?"-1":"2");
			sql_+="and PAY_TYPE ="+ar;
		}
		if(dianXin!=null&&!dianXin.equals("")){
			int ar=Integer.valueOf(request.getParameter("dianXin")=="on"?"-1":"4");
			sql_+="and PAY_TYPE ="+ar;
		}
		if(youXi!=null&&!youXi.equals("")){
			int ar=Integer.valueOf(request.getParameter("youXi")=="on"?"-1":"5");
			sql_+="and PAY_TYPE ="+ar;
		}
		sql+=sql_+sql_1+sql_0;
		List tl = DaoFactory.query(sql);
		List<ChargeStatEntity> l = new ArrayList<ChargeStatEntity>();
		if(tl!=null&&tl.size()>0){
			for(int i=0;i<tl.size();i++){
				Map ms = (Map)tl.get(i);
				ChargeStatEntity u = new ChargeStatEntity();
				u.setStatTime(ms.get("STAT_TIME").toString());
				u.setChTime(Integer.valueOf(ms.get("SUM3").toString()));
				u.setChUser(Integer.valueOf(ms.get("SUM").toString()));
				u.setNewCh(Integer.valueOf(ms.get("SUM2").toString()));
				u.setOldCh(Integer.valueOf(ms.get("SUM1").toString()));
				u.setPayType(Integer.valueOf(ms.get("SUM4").toString()));
				if(ms.get("AGENTNAME")!=null){
				 u.setAgentName(ms.get("AGENTNAME").toString());
				}
				if(ms.get("TEAMNAME")!=null){
					u.setTeamName(ms.get("TEAMNAME").toString());
				}
				if(ms.get("AREANAME")!=null){
					u.setAreaName(ms.get("AREANAME").toString());
				}
				if(ms.get("PICNAME")!=null){
					u.setPicName(ms.get("PICNAME").toString());
				}
				if(ms.get("BUSINESSNAME")!=null){
					u.setBusinessName(ms.get("BUSINESSNAME").toString());
				}
				if(ms.get("CUSTOMERNAME")!=null){
					u.setCustomerName(ms.get("CUSTOMERNAME").toString());
				}
				if(ms.get("PROJECTNAME")!=null){
					u.setProjectName(ms.get("PROJECTNAME").toString());
				}
				if(ms.get("PRODUCTNAME")!=null){
					u.setProductName(ms.get("PRODUCTNAME").toString());
				}
				
				l.add(u);
			}
		}
		
        for (int i =0; i <l.size(); i++){  
        	 int fo=0;
        	 
        	 ChargeStatEntity chargeStatEntity= (ChargeStatEntity) l.get(i);
        	 label = new Label(fo++, i+1, chargeStatEntity.getStatTime()+"");  
             sheet.addCell(label);
             
             if(daiLiShang!=null&&!daiLiShang.equals("")){
             label = new Label(fo++, i+1, chargeStatEntity.getAgentName()+"");  
             sheet.addCell(label);
             }
             
             if(duan!=null&&!duan.equals("")){
             label = new Label(fo++, i+1, chargeStatEntity.getTeamName()+"");  
             sheet.addCell(label);
             }
             
             if(diqu!=null&&!diqu.equals("")){
             label = new Label(fo++, i+1, chargeStatEntity.getAreaName()+"");  
             sheet.addCell(label);
             }
             
             
             if(fu!=null&&!fu.equals("")){
             label = new Label(fo++, i+1, chargeStatEntity.getPicName()+"");  
             sheet.addCell(label);
             }
             
             if(shangWu!=null&&!shangWu.equals("")){
             label = new Label(fo++, i+1, chargeStatEntity.getBusinessName()+"");  
             sheet.addCell(label);
             }
             
             if(keFU!=null&&!keFU.equals("")){
             label = new Label(fo++, i+1, chargeStatEntity.getCustomerName()+"");  
             sheet.addCell(label);
             }
             
             if(xiangMu!=null&&!xiangMu.equals("")){
             label = new Label(fo++, i+1, chargeStatEntity.getProjectName()+"");  
             sheet.addCell(label);
             }
             
             
             if(chanPing!=null&&!chanPing.equals("")){
             label = new Label(fo++, i+1, chargeStatEntity.getProductName()+"");  
             sheet.addCell(label);
             }
             label = new Label(fo++, i+1, chargeStatEntity.getChTime()+"");  
             sheet.addCell(label);
             
             label = new Label(fo++, i+1, chargeStatEntity.getChUser()+"");
             sheet.addCell(label);
             
             label = new Label(fo++, i+1, chargeStatEntity.getOldCh()+"");
             sheet.addCell(label);
             
             label = new Label(fo++, i+1, chargeStatEntity.getNewCh()+"");
             sheet.addCell(label);
             
             sheet.addCell(label);
        }  
        
        wb.write();  
        wb.close();  
		return null;
	}
	